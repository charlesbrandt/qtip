define(["jquery","lodash","ko"],function(n,e,t){var r=function(i){var o=this;o.name=t.observable(""),o.content=t.observable(""),o.children=t.observableArray(),o.parent="",o.size=t.observable(0),o.total_size=t.computed(function(){for(var n=0,e=0,t=o.children().length;t>e;e++)n+=o.children()[e].total_size();return o.size()&&(n+=parseFloat(o.size())),n}),o.size_list=t.computed(function(){for(var n=0,e=[],t=0,r=o.children().length;r>t;t++)n+=o.children()[t].total_size(),e.push(n);return e}),o.editing_name=t.observable(!1),o.edit_name=function(){o.editing_name(!0)},o.editing_size=t.observable(!1),o.edit_size=function(){o.editing_size(!0)},o.editing_content=t.observable(!1),o.edit_content=function(){o.editing_content(!0)},o.id=t.computed(function(){return"."+o.name()}),o.add_new=function(){var n=new r("New Item");o.append(n)},o.append=function(n){o.children.push(n),n.parent=o},o.insert=function(n,e){o.children.splice(e,0,n),n.parent=o},o.remove_self=function(){o.parent.remove(o)},o.remove=function(n){for(var e=o.children.indexOf(n);-1!==e;)o.children.splice(e,1),e=o.children.indexOf(n)},o.clear=function(){return o.children.removeAll()},o.from_json=function(n){e.isString(n)?obj=JSON.parse(n):e.isObject(n)?obj=n:(console.log("Tree.from_json: Unknown object: "+n),obj={}),"name"in obj&&o.name(obj.name),"content"in obj&&o.content(obj.content),"size"in obj&&o.size(obj.size),"children"in obj&&e.each(obj.children,function(n){var e=new r(n);o.append(e)})},e.isString(i)?o.name(i):e.isObject(i)&&o.from_json(i),o.copy=function(){var n={};n.name=o.name(),n.content=o.content(),n.size=o.size(),n.children=[];for(var e=0,t=o.children().length;t>e;e++)n.children[e]=o.children()[e].copy();return n},o.to_json=function(){return copy=o.copy(),JSON.stringify(copy)},o.to_dom=function(e){var t,r,i,a=n("<div/>",{"class":"node",text:o.content(),id:o.name()}),c=n('<ul class="children"/>');for(r=0;r<o.children().length;r++)i=n("<li/>"),t=o.children()[r],t.to_dom(i),i.appendTo(c);c.appendTo(a),a.appendTo(e)},o.from_dom=function(e){var t={};return n("> ul > li > span",e).each(function(){t[n(this).text()]=n(this).hasClass("title")?helper(n(this).parent()):n(this).next("input").val()}),t},o.root=function(){var n,e=o.parent;if(e){for(;e.parent;)e=e.parent;n=e}else n=o;return n},o.neighbors=function(){var n,e=[];if(o.parent)for(var t=0,r=o.parent.children.length;r>t;t++)n=o.parent.children[t],n.name!=o.name()&&e.push(n);return e},o.has_name=function(n){var e,t=!1;if(o.name()==n)t=o;else for(var r=0;r<o.children().length;r++)if(e=o.children()[r].has_name(n)){t=e;break}return t},o.has_item=function(n){var e,t=!1;if(o.name()==n.name&&o.content()==n.content)t=o;else for(var r=0;r<o.children().length;r++)if(e=o.children()[r].has_item(n)){t=e;break}return t},o.path=function(n){for(var e,t,r=n.split("/"),i=o,a=!1,c=0,l=r.length;l>c;c++)if(e=r[c]){for(var s=!1,d=0;d<i.children().length;d++)t=i.children()[d],t.name()==e&&(i=t,s=!0);if(!s)return a=!0,!1}return i},o.max=t.observable(0),o.available=t.computed(function(){return o.max()-o.children().length}),o.available_items=t.computed(function(){for(var n=[],e=0,t=o.available();t>e;e++)n.push(e);return n}),o.post=function(e){var t=o.root();e||(console.log("MISSING ACTION!!"),console.log(e)),n.ajax({url:"json",type:"POST",data:{json:t.to_json(),action:e}})}};return r});